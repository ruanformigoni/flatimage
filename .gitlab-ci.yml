image: "ubuntu:latest"

stages:
  - fetch
  - build
  - package
  - release

fetch-e2fsprogs:
  image: "ubuntu:focal"
  stage: fetch
  when: manual
  before_script:
    - export DEBIAN_FRONTEND=noninteractive
    - apt update && apt -y upgrade
    - apt install -y wget
    - echo JOB_ID_FETCH_E2FSPROGS=$CI_JOB_ID > build.env
  script:
    - |
      mkdir -p bin
      wget -O ./bin/fuse2fs   "https://github.com/ruanformigoni/e2fsprogs/releases/download/9f146d8/fuse2fs"
      wget -O ./bin/e2fsck    "https://github.com/ruanformigoni/e2fsprogs/releases/download/9f146d8/e2fsck"
      wget -O ./bin/resize2fs "https://github.com/ruanformigoni/e2fsprogs/releases/download/9f146d8/resize2fs"
  artifacts:
    paths:
      - ./bin
    reports:
      dotenv: build.env

fetch-extfstools:
  image: "ubuntu:latest"
  stage: fetch
  when: manual
  before_script:
    - export DEBIAN_FRONTEND=noninteractive
    - apt update && apt -y upgrade
    - apt install -y wget
    - echo JOB_ID_FETCH_EXTFS=$CI_JOB_ID > build.env
  script:
    - |
      mkdir -p bin
      wget -O ./bin/ext2rd "https://github.com/ruanformigoni/extfstools/releases/download/58d896b/ext2rd"
  artifacts:
    paths:
      - ./bin
    reports:
      dotenv: build.env

fetch-proot:
  image: "ubuntu:focal"
  stage: fetch
  when: manual
  before_script:
    - export DEBIAN_FRONTEND=noninteractive
    - apt update && apt -y upgrade
    - apt install -y wget
    - echo JOB_ID_FETCH_PROOT=$CI_JOB_ID > build.env
  script:
    - |
      mkdir -p ./bin
      wget -O ./bin/proot "https://github.com/ruanformigoni/proot/releases/download/dd32b56/proot"
  artifacts:
    paths:
      - ./bin
    reports:
      dotenv: build.env

fetch-pcregrep:
  image: "ubuntu:focal"
  stage: fetch
  when: manual
  before_script:
    - export DEBIAN_FRONTEND=noninteractive
    - apt update && apt -y upgrade
    - apt install -y wget git python3-pip patchelf build-essential pcregrep
    - echo JOB_ID_BUILD_DWARFS=$CI_JOB_ID > build.env
  script:
    - |
      mkdir -p bin
      pip3 install setuptools
      pip3 install staticx
      staticx "$(command -v pcregrep)" bin/pcregrep
  artifacts:
    paths:
      - ./bin
    reports:
      dotenv: build.env


build-elf:
  image: docker:latest
  stage: build
  when: manual
  services:
    - docker:dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
    IMAGE_NAME: alpine:arts

  before_script:
    - echo GE_JOB_ID=$CI_JOB_ID >> build.env

  script:
    - mkdir -p bin
    - docker build . -t $CI_REGISTRY/$IMAGE_NAME -f docker/Dockerfile.elf
    - docker run --rm -v $(pwd):/workdir $CI_REGISTRY/$IMAGE_NAME cp /arts/dist/main /workdir/bin/elf

  artifacts:
    paths:
      - ./bin/elf
    reports:
      dotenv: build.env

build-dwarfs:
  image: "ubuntu:jammy"
  stage: build
  when: manual
  before_script:
    - export DEBIAN_FRONTEND=noninteractive
    - apt update && apt -y upgrade
    - apt install -y wget git python3-pip patchelf build-essential g++ clang cmake make bison flex ronn fuse pkg-config binutils-dev libarchive-dev libboost-context-dev libboost-filesystem-dev libboost-program-options-dev libboost-python-dev libboost-regex-dev libboost-system-dev libboost-thread-dev libevent-dev libjemalloc-dev libdouble-conversion-dev libiberty-dev liblz4-dev liblzma-dev libssl-dev libunwind-dev libdwarf-dev libelf-dev libfmt-dev libfuse-dev libgoogle-glog-dev ccache ninja-build libacl1-dev
    - echo JOB_ID_BUILD_DWARFS=$CI_JOB_ID > build.env
  script:
    - |
      mkdir -p ./bin
      # Check if has built version
      if [ -n "$BIN_DWARFS" ] && [ -n "$BIN_MKDWARFS" ]; then
        wget -O ./bin/dwarfs "$BIN_DWARFS"
        wget -O ./bin/mkdwarfs "$BIN_MKDWARFS"
        exit
      fi
      # else build
      git clone --recurse-submodules https://github.com/mhx/dwarfs
      cd dwarfs && mkdir build && cd build
      cmake .. -DWITH_LEGACY_FUSE=1 -DCMAKE_CXX_COMPILER_LAUNCHER=ccache -DWITH_TESTS=0 -GNinja
      ninja
      cd ../..
      pip3 install setuptools
      pip3 install staticx
      staticx dwarfs/build/dwarfs2 bin/dwarfs
      staticx dwarfs/build/mkdwarfs bin/mkdwarfs
  artifacts:
    paths:
      - ./bin
    reports:
      dotenv: build.env

package-focal:
  stage: package
  before_script:
    - apt update && apt -y upgrade
    - apt install -y git wget curl zstd debootstrap e2fsprogs proot fuse2fs xz-utils rsync
    - echo JOB_ID_BUILD_BS_FOCAL=$CI_JOB_ID > build.env
  script:
    # Set dist
    - dist="focal"
    # Build
    - ./src/scripts/_build.sh debootstrap "$dist"
    # Set env vars
    - echo "FOCAL_TARBALL=${dist}.tar.xz" >> build.env
  needs:
    - job: build-elf
      artifacts: true
    - job: fetch-e2fsprogs
      artifacts: true
    - job: build-dwarfs
      artifacts: true
    - job: fetch-extfstools
      artifacts: true
    - job: fetch-proot
      artifacts: true
    - job: fetch-pcregrep
      artifacts: true
  artifacts:
    paths:
      - ./dist
    reports:
      dotenv: build.env

package-arch:
  image: "archlinux:latest"
  stage: package
  before_script:
    - pacman -Syu --noconfirm
    - pacman -S python-pip patchelf git gawk wget curl zstd xz rsync binutils --noconfirm
    - echo JOB_ID_BUILD_BS_ARCH=$CI_JOB_ID > build.env
  script:
    # Build
    - ./src/scripts/_build.sh archbootstrap
    # Set env vars
    - echo "ARCH_TARBALL=arch.tar.xz" >> build.env
  needs:
    - job: build-elf
      artifacts: true
    - job: fetch-e2fsprogs
      artifacts: true
    - job: build-dwarfs
      artifacts: true
    - job: fetch-extfstools
      artifacts: true
    - job: fetch-proot
      artifacts: true
    - job: fetch-pcregrep
      artifacts: true
  artifacts:
    paths:
      - ./dist
    reports:
      dotenv: build.env

package-alpine:
  image: "archlinux:latest"
  stage: package
  before_script:
    - pacman -Syu --noconfirm
    - pacman -S python-pip patchelf git gawk wget curl zstd xz rsync binutils --noconfirm
    - echo JOB_ID_BUILD_BS_ALPINE=$CI_JOB_ID > build.env
  script:
    # Build
    - ./src/scripts/_build.sh alpinebootstrap
    # Set env vars
    - echo "ALPINE_TARBALL=alpine.tar.xz" >> build.env
  needs:
    - job: build-elf
      artifacts: true
    - job: fetch-e2fsprogs
      artifacts: true
    - job: build-dwarfs
      artifacts: true
    - job: fetch-extfstools
      artifacts: true
    - job: fetch-proot
      artifacts: true
    - job: fetch-pcregrep
      artifacts: true
  artifacts:
    paths:
      - ./dist
    reports:
      dotenv: build.env

deploy:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  before_script:
    - apk --no-cache add curl
  script:
    - |
      export RELEASE_DESCRIPTION="$(date +"%Y-%m-%d")"
      # Delete current release
      curl --header "PRIVATE-TOKEN: $PRIVATE_TOKEN" --request DELETE "https://gitlab.com/api/v4/projects/43000137/releases/Continuous" || true
  # Set new release
  release: # See https://docs.gitlab.com/ee/ci/yaml/#release for available properties
    tag_name: 'Continuous'
    description: 'Release $CI_COMMIT_SHORT_SHA : ${RELEASE_DESCRIPTION}'
    assets:
      links:
        - name: 'focal.tar.xz'
          url: 'https://gitlab.com/formigoni/art/-/jobs/${JOB_ID_BUILD_BS_FOCAL}/artifacts/raw/dist/${FOCAL_TARBALL}'
        - name: 'arch.tar.xz'
          url: 'https://gitlab.com/formigoni/art/-/jobs/${JOB_ID_BUILD_BS_ARCH}/artifacts/raw/dist/${ARCH_TARBALL}'
        - name: 'alpine.tar.xz'
          url: 'https://gitlab.com/formigoni/art/-/jobs/${JOB_ID_BUILD_BS_ALPINE}/artifacts/raw/dist/${ALPINE_TARBALL}'
  needs:
    - job: package-arch
    - job: package-focal
    - job: package-alpine
      artifacts: true
